<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>주문 확인</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/css/style.css" rel="stylesheet" />
    <style>
        body { font-family: Arial, sans-serif; margin:0; background:#f7f7f9; }
        header { background:#111827; color:#fff; padding:16px 20px; font-weight:bold; }
        .container { max-width: 760px; margin: 24px auto; background:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:20px; }
        .section { padding: 14px 0; border-bottom:1px solid #eef2f7; }
        .section:last-child { border-bottom:none; }
        .label { font-size:13px; color:#6b7280; margin-bottom:6px; }
        .row { display:flex; gap:18px; align-items:center; }
        .space { height:10px; }
        .title { font-size:20px; font-weight:800; color:#111827; }
        .muted { color:#6b7280; }
        .price { color:#2563eb; font-weight:700; }
        .btn { width:100%; padding:14px; border:none; border-radius:10px; background:#0064FF; color:#fff; font-weight:800; cursor:pointer; }
        .btn:disabled { background:#9ca3af; cursor:not-allowed; }
        .sum { display:flex; justify-content:space-between; align-items:center; font-size:16px; }
        .toast { position:fixed; right:20px; bottom:20px; background:#111827; color:#fff; padding:12px 14px; border-radius:8px; display:none; }
        .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background:#f3f4f6; border:1px solid #e5e7eb; padding:2px 6px; border-radius:6px; }
    </style>
</head>
<body>
<header>주문 확인</header>

<div class="container">
    <!-- 회원 정보 -->
    <div class="section" id="memberSec">
        <div class="label">주문자</div>
        <div><span id="name" class="title">-</span></div>
        <div class="muted" id="email">-</div>
    </div>

    <!-- 상품 정보 -->
    <div class="section" id="productSec">
        <div class="label">상품</div>
        <div id="productName" class="title">-</div>
        <div class="muted" id="productDesc">-</div>
        <div class="space"></div>
        <div class="sum">
            <div>수량 <span class="kbd" id="qtyView">1</span></div>
            <div class="price">단가 ₩ <span id="unitPrice">0</span></div>
        </div>
        <div class="sum" style="margin-top:8px;">
            <div class="muted">총 합계</div>
            <div class="price">₩ <span id="totalPrice">0</span></div>
        </div>
    </div>

    <!-- 결제 액션 -->
    <div class="section">
        <button id="btnPay" class="btn" disabled>결제하기</button>
        <div class="muted" style="margin-top:8px;">결제 단계에서 주문번호가 생성됩니다.</div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    const api = (path, opts={}) => fetch(path, { credentials: 'include', ...opts });
    const fmt = (n) => new Intl.NumberFormat('ko-KR').format(n);

    // URL 파라미터
    const url = new URL(location.href);
    const productId = url.searchParams.get('productId');
    const qtyParam = url.searchParams.get('qty');
    let quantity = Math.max(1, parseInt(qtyParam || '1', 10));
    let currentOrderId = url.searchParams.get('orderId'); // 이미 있으면 그대로 사용

    // 화면 요소
    const nameEl = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const productNameEl = document.getElementById('productName');
    const productDescEl = document.getElementById('productDesc');
    const unitPriceEl = document.getElementById('unitPrice');
    const totalPriceEl = document.getElementById('totalPrice');
    const qtyViewEl = document.getElementById('qtyView');
    const btnPay = document.getElementById('btnPay');

    function showToast(msg, ms = 1800) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => (t.style.display = 'none'), ms);
    }

    if (!productId) {
        alert('productId가 없습니다.');
        location.href = '/products.html';
    }

    // 데이터 로드
    let unitPrice = 0;

    async function loadMember() {
        const res = await api('/api/member/info');

        if (res.status === 401 || res.status === 403) {
            window.location.href = '/login.html';
            return;
        }

        if (!res.ok) {
            console.error('회원 정보를 불러오지 못했습니다.');
            return;
        }

        const data = await res.json().catch(() => ({}));
        if (data.code === '401') {
            window.location.href = '/login.html';
            return;
        }
        const body = data?.body ?? data;

        const name = body.name;
        const email = body.email;

        nameEl.textContent = name;
        emailEl.textContent = email;
    }

    async function loadProduct() {
        const res = await api(`/api/product/${productId}`);
        if (!res.ok) { showToast('상품 정보를 불러오지 못했습니다.'); return; }
        const data = await res.json();
        const p = data?.body ?? data;
        productNameEl.textContent = p.name ?? '-';
        productDescEl.textContent = p.description ?? '';
        unitPrice = Number(p.price || 0);
        unitPriceEl.textContent = fmt(unitPrice);
        qtyViewEl.textContent = String(quantity);
        totalPriceEl.textContent = fmt(unitPrice * quantity);
    }

    async function createOrder() {
        if (currentOrderId) return currentOrderId;
        // 서버에 맞춰 바디 필드명 맞추기 (예: productId, quantity)
        const res = await api('/api/order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId: Number(productId), quantity })
        });
        if (!res.ok) {
            const txt = await res.text().catch(()=> '');
            showToast('주문 생성 실패');
            console.error('create order failed:', txt);
            throw new Error('order create failed');
        }
        const data = await res.json().catch(()=> ({}));
        const body = data?.body ?? data;
        currentOrderId = body.orderId ?? body.id;
        if (!currentOrderId) throw new Error('orderId not found in response');
        return currentOrderId;
    }

    // 결제하기 버튼
    btnPay.addEventListener('click', async () => {
        try {
            btnPay.disabled = true;
            const orderId = await createOrder();
            // 결제 위젯 화면으로 이동
            location.href = `/payment/widget/${orderId}`;
        } catch (e) {
            showToast('결제로 이동할 수 없습니다.');
        } finally {
            btnPay.disabled = false;
        }
    });

    // 초기 로드
    (async () => {
        await Promise.allSettled([loadMember(), loadProduct()]);
        // 사용자/상품 데이터를 불러온 후 결제 버튼 활성화
        btnPay.disabled = false;
    })();
</script>
</body>
</html>
